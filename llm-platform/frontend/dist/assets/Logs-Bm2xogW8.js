import{a as _e}from"./admin-BeQPA_vV.js";import{c as A}from"./index-DcR-k5ux.js";import{O as k,R as r,o as E,S as pe}from"./element-plus-CLNn8XtP.js";import{k as me,r as c,c as ve,d as fe,l as _,q as a,G as t,A as o,a8 as u,E as p,z as F,u as J,C as y,m as i}from"./vue-vendor-CBcJ4V7k.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-DzVZk42n.js";const ye={class:"admin-logs"},he={class:"page-header"},be={class:"header-actions"},ke={class:"search-form"},we={key:0,class:"loading"},xe={class:"user-id"},Ce={class:"model-name"},Ve={key:0,class:"error-message"},ze={key:1,class:"text-success"},De={class:"table-actions"},Ye={class:"pagination-wrapper"},Se={key:0,class:"log-detail"},qe={class:"detail-grid"},Le={class:"detail-item"},Me={class:"detail-item"},Re={class:"detail-item"},He={class:"detail-item"},Ie={class:"detail-item"},Ne={class:"detail-item"},Te={class:"detail-item"},Be={key:0,class:"detail-item"},Ue={key:0,class:"detail-section"},Oe={class:"json-content"},Ae={key:1,class:"detail-section"},Ee={class:"json-content"},Fe={key:2,class:"detail-section"},Je={class:"error-content"},Pe={class:"error-message"},je={key:0,class:"error-traceback"},$e=me({__name:"Logs",setup(Ge){const C=c(!1),S=c(!1),V=c(""),h=c(""),v=c(""),f=c(null),b=c(1),z=c(50),q=c(0),L=c([]),n=c(null),P=ve(()=>{let l=L.value;if(V.value){const e=V.value.toLowerCase();l=l.filter(g=>g.user_id.toString().includes(e)||g.error_message&&g.error_message.toLowerCase().includes(e))}return h.value&&(l=l.filter(e=>e.request_type===h.value)),v.value&&(v.value==="200"?l=l.filter(e=>e.status_code===200):v.value==="4xx"?l=l.filter(e=>e.status_code>=400&&e.status_code<500):v.value==="5xx"&&(l=l.filter(e=>e.status_code>=500))),l}),M=l=>({chat:"primary",chat_stream:"success",completions:"info",embeddings:"warning"})[l]||"info",R=l=>({chat:"对话",chat_stream:"流式对话",completions:"文本补全",embeddings:"嵌入向量"})[l]||l,H=l=>l===200?"success":l>=400&&l<500?"warning":l>=500?"danger":"info",I=l=>l<100?"latency-good":l<500?"latency-normal":"latency-slow",N=l=>{try{return JSON.stringify(typeof l=="string"?JSON.parse(l):l,null,2)}catch{return l}},w=async(l=1)=>{try{C.value=!0;const e={page:l,page_size:z.value};f.value&&(e.start_date=f.value[0],e.end_date=f.value[1]);const g=await _e.getLogs(e);L.value=g.items,q.value=g.total}catch(e){k.error("获取日志失败"),console.error("Failed to load logs:",e)}finally{C.value=!1}},j=async()=>{await w(b.value),k.success("日志已刷新")},$=()=>{},T=()=>{},G=()=>{b.value=1,w(1)},Q=l=>{z.value=l,b.value=1,w(1)},K=l=>{b.value=l,w(l)},W=l=>{n.value=l,S.value=!0},X=async l=>{try{await pe.confirm("确定要重试这个失败的请求吗？","重试请求",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),k.success("请求已重新提交")}catch(e){e!=="cancel"&&k.error("重试失败")}},Z=async()=>{try{const l={export:!0};h.value&&(l.request_type=h.value),v.value&&(l.status_filter=v.value),f.value&&(l.start_date=f.value[0],l.end_date=f.value[1]),k.success("日志导出功能开发中")}catch{k.error("导出失败")}};return fe(async()=>{await w()}),(l,e)=>{const g=u("Refresh"),x=u("el-icon"),D=u("el-button"),ee=u("Download"),te=u("Search"),le=u("el-input"),m=u("el-option"),B=u("el-select"),ae=u("el-date-picker"),U=u("el-card"),se=u("el-skeleton"),d=u("el-table-column"),Y=u("el-tag"),oe=u("View"),O=u("el-tooltip"),ne=u("RefreshRight"),re=u("el-empty"),ue=u("el-table"),ie=u("el-pagination"),de=u("el-dialog");return i(),_("div",ye,[a("div",he,[e[9]||(e[9]=a("div",{class:"header-content"},[a("h1",null,"系统日志"),a("p",null,"查看API调用日志、错误记录和系统事件")],-1)),a("div",be,[t(D,{onClick:j,loading:C.value},{default:o(()=>[t(x,null,{default:o(()=>[t(g)]),_:1}),e[7]||(e[7]=p(" 刷新 "))]),_:1,__:[7]},8,["loading"]),t(D,{onClick:Z},{default:o(()=>[t(x,null,{default:o(()=>[t(ee)]),_:1}),e[8]||(e[8]=p(" 导出 "))]),_:1,__:[8]})])]),t(U,{shadow:"never",class:"search-card"},{default:o(()=>[a("div",ke,[t(le,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=s=>V.value=s),placeholder:"搜索用户ID或错误信息",clearable:"",style:{width:"300px"},onInput:$},{prefix:o(()=>[t(x,null,{default:o(()=>[t(te)]),_:1})]),_:1},8,["modelValue"]),t(B,{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=s=>h.value=s),placeholder:"请求类型",clearable:"",style:{width:"150px"},onChange:T},{default:o(()=>[t(m,{label:"全部",value:""}),t(m,{label:"对话",value:"chat"}),t(m,{label:"流式对话",value:"chat_stream"}),t(m,{label:"文本补全",value:"completions"}),t(m,{label:"嵌入向量",value:"embeddings"})]),_:1},8,["modelValue"]),t(B,{modelValue:v.value,"onUpdate:modelValue":e[2]||(e[2]=s=>v.value=s),placeholder:"状态码",clearable:"",style:{width:"120px"},onChange:T},{default:o(()=>[t(m,{label:"全部",value:""}),t(m,{label:"成功 (200)",value:"200"}),t(m,{label:"客户端错误 (4xx)",value:"4xx"}),t(m,{label:"服务器错误 (5xx)",value:"5xx"})]),_:1},8,["modelValue"]),t(ae,{modelValue:f.value,"onUpdate:modelValue":e[3]||(e[3]=s=>f.value=s),type:"datetimerange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",onChange:G,style:{width:"320px"}},null,8,["modelValue"])])]),_:1}),t(U,{shadow:"never"},{default:o(()=>[C.value?(i(),_("div",we,[t(se,{rows:10,animated:""})])):(i(),F(ue,{key:1,data:P.value,style:{width:"100%"},"row-key":"id","default-sort":{prop:"created_at",order:"descending"}},{empty:o(()=>[t(re,{description:"暂无日志数据"})]),default:o(()=>[t(d,{prop:"created_at",label:"时间",width:"160",sortable:""},{default:o(({row:s})=>[p(r(J(A)(s.created_at,"YYYY-MM-DD HH:mm:ss")),1)]),_:1}),t(d,{prop:"request_type",label:"类型",width:"100"},{default:o(({row:s})=>[t(Y,{size:"small",type:M(s.request_type)},{default:o(()=>[p(r(R(s.request_type)),1)]),_:2},1032,["type"])]),_:1}),t(d,{prop:"user_id",label:"用户",width:"80"},{default:o(({row:s})=>[a("span",xe,r(s.user_id),1)]),_:1}),t(d,{prop:"model_name",label:"模型",width:"120","show-overflow-tooltip":""},{default:o(({row:s})=>[a("span",Ce,r(s.model_name||"-"),1)]),_:1}),t(d,{prop:"status_code",label:"状态",width:"80",sortable:""},{default:o(({row:s})=>[t(Y,{size:"small",type:H(s.status_code)},{default:o(()=>[p(r(s.status_code),1)]),_:2},1032,["type"])]),_:1}),t(d,{prop:"latency_ms",label:"延迟",width:"80",sortable:""},{default:o(({row:s})=>[a("span",{class:E(I(s.latency_ms))},r(s.latency_ms)+"ms ",3)]),_:1}),t(d,{prop:"prompt_tokens",label:"Input",width:"80"},{default:o(({row:s})=>[p(r(s.prompt_tokens||"-"),1)]),_:1}),t(d,{prop:"completion_tokens",label:"Output",width:"80"},{default:o(({row:s})=>[p(r(s.completion_tokens||"-"),1)]),_:1}),t(d,{prop:"total_tokens",label:"Total",width:"80"},{default:o(({row:s})=>[p(r(s.total_tokens||"-"),1)]),_:1}),t(d,{prop:"error_message",label:"错误信息","min-width":"200","show-overflow-tooltip":""},{default:o(({row:s})=>[s.error_message?(i(),_("span",Ve,r(s.error_message),1)):(i(),_("span",ze,"-"))]),_:1}),t(d,{label:"操作",width:"120",fixed:"right"},{default:o(({row:s})=>[a("div",De,[t(O,{content:"查看详情"},{default:o(()=>[t(D,{size:"small",text:"",type:"primary",onClick:ce=>W(s)},{default:o(()=>[t(x,null,{default:o(()=>[t(oe)]),_:1})]),_:2},1032,["onClick"])]),_:2},1024),s.status_code!==200?(i(),F(O,{key:0,content:"重试请求"},{default:o(()=>[t(D,{size:"small",text:"",type:"warning",onClick:ce=>X(s)},{default:o(()=>[t(x,null,{default:o(()=>[t(ne)]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)):y("",!0)])]),_:1})]),_:1},8,["data"])),a("div",Ye,[t(ie,{"current-page":b.value,"onUpdate:currentPage":e[4]||(e[4]=s=>b.value=s),"page-size":z.value,"onUpdate:pageSize":e[5]||(e[5]=s=>z.value=s),"page-sizes":[20,50,100,200],total:q.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Q,onCurrentChange:K},null,8,["current-page","page-size","total"])])]),_:1}),t(de,{modelValue:S.value,"onUpdate:modelValue":e[6]||(e[6]=s=>S.value=s),title:"日志详情",width:"800px","destroy-on-close":""},{default:o(()=>[n.value?(i(),_("div",Se,[a("div",qe,[a("div",Le,[e[10]||(e[10]=a("label",null,"时间:",-1)),a("span",null,r(J(A)(n.value.created_at,"YYYY-MM-DD HH:mm:ss")),1)]),a("div",Me,[e[11]||(e[11]=a("label",null,"请求类型:",-1)),t(Y,{size:"small",type:M(n.value.request_type)},{default:o(()=>[p(r(R(n.value.request_type)),1)]),_:1},8,["type"])]),a("div",Re,[e[12]||(e[12]=a("label",null,"用户ID:",-1)),a("span",null,r(n.value.user_id),1)]),a("div",He,[e[13]||(e[13]=a("label",null,"API密钥ID:",-1)),a("span",null,r(n.value.api_key_id),1)]),a("div",Ie,[e[14]||(e[14]=a("label",null,"模型:",-1)),a("span",null,r(n.value.model_name||"-"),1)]),a("div",Ne,[e[15]||(e[15]=a("label",null,"状态码:",-1)),t(Y,{size:"small",type:H(n.value.status_code)},{default:o(()=>[p(r(n.value.status_code),1)]),_:1},8,["type"])]),a("div",Te,[e[16]||(e[16]=a("label",null,"延迟:",-1)),a("span",{class:E(I(n.value.latency_ms))},r(n.value.latency_ms)+"ms ",3)]),n.value.total_tokens?(i(),_("div",Be,[e[17]||(e[17]=a("label",null,"Token使用:",-1)),a("span",null,r(n.value.prompt_tokens||0)+" + "+r(n.value.completion_tokens||0)+" = "+r(n.value.total_tokens),1)])):y("",!0)]),n.value.request_data?(i(),_("div",Ue,[e[18]||(e[18]=a("h4",null,"请求数据",-1)),a("pre",Oe,r(N(n.value.request_data)),1)])):y("",!0),n.value.response_data?(i(),_("div",Ae,[e[19]||(e[19]=a("h4",null,"响应数据",-1)),a("pre",Ee,r(N(n.value.response_data)),1)])):y("",!0),n.value.error_message?(i(),_("div",Fe,[e[21]||(e[21]=a("h4",null,"错误信息",-1)),a("div",Je,[a("p",Pe,r(n.value.error_message),1),n.value.error_traceback?(i(),_("div",je,[e[20]||(e[20]=a("h5",null,"错误堆栈",-1)),a("pre",null,r(n.value.error_traceback),1)])):y("",!0)])])):y("",!0)])):y("",!0)]),_:1},8,["modelValue"])])}}}),tt=ge($e,[["__scopeId","data-v-52dd8149"]]);export{tt as default};
