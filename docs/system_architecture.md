# 系统架构设计：企业级大模型克隆平台

## 1. 核心设计原则

- **松耦合 (Loosely Coupled)**：各组件应通过定义良好的API进行通信，减少相互依赖，便于独立开发、部署和扩展。
- **高内聚 (High Cohesion)**：每个微服务都应聚焦于一个明确的业务功能，例如模型推理、用户认证、日志记录等。
- **可观测性 (Observability)**：系统必须提供详细的日志、指标和追踪信息，以便于监控、调试和性能优化。
- **安全性 (Security)**：安全是设计的首要考虑因素，覆盖从用户认证到数据传输、模型访问的每一个环节。
- **可扩展性 (Scalability)**：架构设计必须支持水平扩展，以应对不断增长的业务需求和并发量。

## 2. 系统架构图 (高层次)

```mermaid
graph TD
    subgraph "用户/客户端"
        A[Web/Mobile App]
        B[第三方应用]
    end

    subgraph "入口与接入层"
        C[API 网关]
    end

    subgraph "核心服务层 (微服务)"
        D[认证服务]
        E[用户管理服务]
        F[模型路由与负载均衡服务]
        G[任务队列服务]
        H[结果缓存服务]
    end

    subgraph "模型推理层"
        I[统一模型抽象接口]
        J[模型服务 (Deepseek)]
        K[模型服务 (GPT)]
        L[模型服务 (其他...)]
    end

    subgraph "基础设施与支撑服务"
        M[数据库 (PostgreSQL)]
        N[缓存 (Redis)]
        O[消息队列 (RabbitMQ/Kafka)]
        P[日志服务 (ELK/Loki)]
        Q[监控告警 (Prometheus/Grafana)]
        R[配置中心 (Consul/Nacos)]
    end

    subgraph "管理后台"
        S[Admin UI]
    end

    A --> C
    B --> C
    C --> D{认证}
    C --> F
    F --> I
    I --> J
    I --> K
    I --> L
    F --> G
    F --> H
    C --> E
    S --> E
    S --> Q
    
    D --> M
    E --> M
    F --> R
    H --> N
    G --> O

    J --> Q
    K --> Q
    L --> Q
    F --> P
    C --> P

    style I fill:#f9f,stroke:#333,stroke-width:2px
```

## 3. 组件职责说明

- **API网关 (API Gateway)**:
  - **职责**: 系统的唯一入口，处理所有外部请求。
  - **功能**:
    - **请求路由**: 根据请求路径和版本，将请求转发到相应的后端微服务。
    - **安全认证**: 与认证服务集成，校验JWT Token或API Key。
    - **流量控制**: 实现速率限制（Rate Limiting）和并发控制。
    - **协议转换**: 支持HTTP/S和WebSocket，并将请求转换为内部gRPC或HTTP协议。
    - **请求/响应转换**: 对数据格式进行转换和校验。
    - **初步日志记录**: 记录所有请求的元数据。

- **模型路由与负载均衡服务 (Model Router & Load Balancer)**:
  - **职责**: 接收来自API网关的推理请求，并智能地选择一个健康的、负载较低的模型实例来处理。
  - **功能**:
    - **动态路由**: 根据请求参数（如指定的模型、版本）选择后端模型服务。
    - **负载均衡**: 支持轮询、最少连接、加权等多种负载均衡策略。
    - **健康检查**: 定期检查后端模型服务的健康状况，自动剔除不健康的实例。
    - **故障转移与回退**: 当主模型服务失败时，可自动切换到备用模型（如从GPT-4切换到GPT-3.5）。
    - **成本优化**: 可根据策略，优先将请求路由到成本较低的模型。

- **统一模型抽象接口 (Unified Model Interface)**:
  - **职责**: 定义一个标准的接口，屏蔽不同大模型API之间的差异。
  - **功能**:
    - **标准化输入/输出**: 将不同格式的请求（如OpenAI格式、Deepseek格式）统一转换为标准内部格式。
    - **适配器模式**: 为每个具体模型实现一个适配器（Adapter），负责调用实际的模型API并处理其特定的返回格式。
    - **功能映射**: 将通用的功能（如文本生成、对话、嵌入）映射到具体模型的API调用上。

- **模型服务 (Model Service)**:
  - **职责**: 包装和提供具体大模型的推理能力。
  - **功能**:
    - **API调用**: 封装对原始模型提供商（如OpenAI, Deepseek）API的调用逻辑。
    - **凭证管理**: 安全地管理和使用各类模型的API Key。
    - **错误处理**: 处理模型API可能返回的特定错误。

- **认证服务 (Auth Service)**:
  - **职责**: 负责用户身份验证和授权。
  - **功能**:
    - **JWT生成与验证**: 用户登录成功后，生成JWT；对后续请求中的JWT进行验证。
    - **API密钥管理**: 创建、分发、禁用和轮换API密钥。
    - **权限控制**: 定义角色和权限，控制用户对不同API和模型的访问权限。

- **任务队列服务 (Task Queue Service)**:
  - **职责**: 处理耗时的、异步的请求。
  - **功能**:
    - **异步处理**: 对于需要长时间处理的请求（如批量处理文件），将其放入队列，由Worker异步执行。
    - **削峰填谷**: 应对突发流量，保护后端服务不被压垮。

- **结果缓存服务 (Result Cache Service)**:
  - **职责**: 缓存相同请求的结果，降低延迟，减少对模型API的重复调用。
  - **功能**:
    - **缓存策略**: 基于请求内容（如prompt）生成缓存键（Cache Key）。
    - **缓存失效**: 设置合理的缓存过期时间（TTL）。
    - **支持流式缓存**: 对流式响应进行分块缓存。

- **管理后台 (Admin UI)**:
  - **职责**: 提供一个图形化界面，方便管理员进行系统管理和监控。
  - **功能**:
    - **用户管理**: 查看、创建、编辑用户信息。
    - **模型配置**: 管理和配置接入的模型、API Key、路由规则等。
    - **监控仪表板**: 可视化展示系统关键指标（QPS、延迟、错误率等）。
    - **API使用统计**: 统计和分析API调用情况。
